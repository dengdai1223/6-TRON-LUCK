<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TronLuck | å»ä¸­å¿ƒåŒ–æ¸¸æˆé‡‘èåè®®ï¼ï¼ï¼ï¼</title>
    
    <link rel="manifest" href="https://dengdai1223.github.io/6-TRON-LUCK/manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="https://unpkg.com/@walletconnect/client@1.8.0/dist/umd/index.min.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { bg: '#0f111a', surface: '#1e212b', primary: '#8b5cf6', secondary: '#10b981' } } } }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #0f111a; color: #fff; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(30, 33, 43, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .feature-card { border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.03); }
        .modal-bg { background-color: rgba(0, 0, 0, 0.7); }
    </style>
</head>

<body x-data="app()" class="flex flex-col h-screen overflow-hidden">

    <header class="h-14 px-4 flex items-center justify-between glass fixed top-0 w-full z-50">
        <div class="font-bold text-lg tracking-wider flex items-center gap-2">
            <i class="fa-solid fa-cube text-primary"></i> Tron<span class="text-white">Luck</span>
        </div>
        
        <button x-show="!wallet" @click="walletSelectModalOpen = true" 
            class="text-xs bg-primary hover:bg-purple-600 text-white border border-purple-500 rounded-full px-4 py-1.5 flex items-center gap-2 transition active:scale-95 shadow-lg">
            <i class="fa-solid fa-wallet"></i> 
            <span x-text="btnText">è¿æ¥é’±åŒ…</span>
        </button>

        <div x-show="wallet" class="flex items-center gap-2 bg-surface border border-gray-700 rounded-full pl-3 pr-1 py-1">
            <div class="flex items-center gap-1">
                <span class="text-green-400 font-bold text-xs" x-text="balance">0</span>
                <span class="text-[10px] text-gray-500">TRX</span>
            </div>
            <div class="w-[1px] h-4 bg-gray-700 mx-1"></div>
            <span class="text-xs text-gray-300 font-mono" x-text="shortAddr(wallet)"></span>
            <button @click="disconnect()" class="w-6 h-6 rounded-full bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white flex items-center justify-center transition ml-1">
                <i class="fa-solid fa-power-off text-[10px]"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto pt-16 pb-24 px-4 space-y-8">
        <div x-show="activeTab === 'home'" x-transition.opacity class="space-y-8">
            <div class="text-center py-8">
                <div class="inline-block px-3 py-1 rounded-full bg-primary/20 text-primary text-xs font-bold mb-4 border border-primary/30">ğŸš€ æ³¢åœº 0 Gas æ¸¸æˆé‡‘èåè®®</div>
                <h1 class="text-4xl font-bold mb-4 leading-tight"><span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">å»ä¸­å¿ƒåŒ–</span><br>å…¬å¹³ä¸è´¢å¯Œé‡æ„</h1>
                <p class="text-gray-400 text-sm mb-6 px-4">TronLuck æ˜¯ç”±æ™ºèƒ½åˆçº¦é©±åŠ¨çš„æµåŠ¨æ€§åè®®ã€‚ç©å®¶äº«å— 0 ç£¨æŸçš„å…¬å¹³åšå½©ï¼ŒæŠ•èµ„è€…äº«å—çœŸå®çš„ç°é‡‘æµåˆ†çº¢ã€‚</p>
                <div class="flex justify-center gap-4">
                    <button @click="activeTab='game'" class="bg-primary text-white px-8 py-3 rounded-full font-bold shadow-lg active:scale-95 transition">å¼€å§‹æ¸¸æˆ</button>
                    <button @click="activeTab='wealth'" class="bg-surface border border-gray-700 text-white px-8 py-3 rounded-full font-bold active:scale-95 transition">å‚ä¸ä¼—ç­¹</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="feature-card p-4 rounded-xl"><i class="fa-solid fa-code text-2xl text-blue-400 mb-2"></i><h4 class="font-bold text-sm">æ™ºèƒ½åˆçº¦æ‰˜ç®¡</h4><p class="text-[10px] text-gray-400 mt-1">èµ„é‡‘é”å®šåœ¨é“¾ä¸Šåˆçº¦ï¼Œç®¡ç†å‘˜æ— æ³•æŒªç”¨ã€‚</p></div>
                <div class="feature-card p-4 rounded-xl"><i class="fa-solid fa-wallet text-2xl text-purple-400 mb-2"></i><h4 class="font-bold text-sm">èµ„é‡‘åœ¨æ‚¨æ‰‹ä¸­</h4><p class="text-[10px] text-gray-400 mt-1">éæ‰˜ç®¡å¼æ¸¸æˆã€‚ä¸ä¸‹æ³¨æ—¶èµ„é‡‘100%åœ¨æ‚¨çš„é’±åŒ…ã€‚</p></div>
            </div>
            <div class="bg-surface/30 p-4 rounded-xl border border-gray-800">
                <h3 class="font-bold text-sm mb-3">ğŸ—ºï¸ å‘å±•è·¯çº¿å›¾</h3>
                <ul class="text-xs text-gray-400 space-y-2">
                    <li class="flex gap-2"><span class="text-primary">â—</span> Phase 1: åè®®å¯åŠ¨ï¼Œä¸Šçº¿å“ˆå¸Œæ¸¸æˆã€‚</li>
                    <li class="flex gap-2"><span class="text-gray-600">â—</span> Phase 2: SunPump å‘å¸ä¸ç©ºæŠ•ã€‚</li>
                </ul>
            </div>
        </div>

        <div x-show="activeTab === 'game'" x-transition>
            <div class="bg-gradient-to-r from-purple-900 to-indigo-900 rounded-2xl p-5 mb-6 shadow-lg">
                <p class="text-xs text-purple-200 mb-1">å¥–é‡‘æ± </p><h2 class="text-3xl font-bold text-white mb-2">128,500 <span class="text-sm">TRX</span></h2>
                <div class="flex gap-2"><span class="bg-black/20 text-[10px] px-2 py-1 rounded text-green-300">âœ… å³æ—¶èµ”ä»˜</span><span class="bg-black/20 text-[10px] px-2 py-1 rounded text-yellow-300">âš¡ 0 Gasè´¹</span></div>
            </div>
            <div @click="openGame('classic')" class="bg-surface rounded-xl p-4 flex items-center justify-between mb-4 border border-gray-800 active:scale-[0.98] transition cursor-pointer">
                <div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-purple-500/10 flex items-center justify-center text-purple-400 text-xl"><i class="fa-solid fa-hashtag"></i></div><div><h4 class="font-bold text-white">å“ˆå¸ŒçŒœå•åŒ</h4><p class="text-xs text-gray-500">èµ”ç‡ 1.98</p></div></div><button class="bg-primary text-white text-xs px-4 py-2 rounded-full font-bold">Play</button>
            </div>
        </div>

        <div x-show="activeTab === 'wealth'" x-transition>
            <div class="bg-surface p-1 rounded-lg flex mb-6"><button @click="investType='equity'" :class="investType==='equity'?'bg-gray-700 text-white':'text-gray-500'" class="flex-1 py-2 text-sm font-bold rounded">æˆ‘æ˜¯è‚¡ä¸œ</button><button @click="investType='fixed'" :class="investType==='fixed'?'bg-gray-700 text-white':'text-gray-500'" class="flex-1 py-2 text-sm font-bold rounded">å®šæœŸç†è´¢</button></div>
            <div x-show="investType==='equity'" class="text-center py-4"><h2 class="text-4xl font-bold text-primary">12.5%</h2><p class="text-xs text-gray-400">å†å²æœˆåŒ–</p><div class="bg-surface rounded-xl p-5 border border-gray-800 mt-4 flex gap-3"><input type="number" x-model="investAmount" placeholder="è¾“å…¥ TRX" class="flex-1 bg-black/30 border border-gray-700 rounded-lg px-3 text-sm text-white focus:outline-none"><button @click="doInvest()" class="bg-primary text-white px-6 py-2 rounded-lg text-sm font-bold">å­˜å…¥</button></div></div>
            <div x-show="investType==='fixed'" class="space-y-4"><div class="bg-surface rounded-xl p-4 border-l-4 border-blue-500 flex justify-between items-center"><div><h3 class="font-bold text-white">ç¨³å¥æœˆå¡</h3><p class="text-xs text-gray-400">é”ä»“ 30 å¤©</p></div><div class="text-right"><div class="text-xl font-bold text-green-400">30%</div><div class="text-[10px] text-gray-500">å¹´åŒ– APY</div></div></div></div>
        </div>

        <div x-show="activeTab === 'mine'" x-transition>
            <div class="bg-surface rounded-2xl p-6 text-center mb-6 border border-gray-800"><div class="w-16 h-16 bg-gray-700 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl">ğŸ‘¾</div><h2 x-text="wallet ? shortAddr(wallet) : 'æœªè¿æ¥é’±åŒ…'" class="font-bold text-lg"></h2><div x-show="wallet" class="mt-2 text-sm text-green-400 font-bold" x-text="balance + ' TRX'"></div></div>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full glass border-t border-gray-800 pb-safe z-50">
        <div class="flex justify-around items-center h-16">
            <button @click="activeTab='home'" class="flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-house text-lg" :class="activeTab==='home'?'text-primary':'text-gray-500'"></i><span class="text-[10px]">é¦–é¡µ</span></button>
            <button @click="activeTab='game'" class="flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-gamepad text-lg" :class="activeTab==='game'?'text-primary':'text-gray-500'"></i><span class="text-[10px]">å¤§å…</span></button>
            <button @click="activeTab='wealth'" class="flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-sack-dollar text-lg" :class="activeTab==='wealth'?'text-primary':'text-gray-500'"></i><span class="text-[10px]">ç†è´¢</span></button>
            <button @click="activeTab='mine'" class="flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-user text-lg" :class="activeTab==='mine'?'text-primary':'text-gray-500'"></i><span class="text-[10px]">æˆ‘çš„</span></button>
        </div>
    </nav>

    <div x-show="gameModalOpen" class="fixed inset-0 z-[60] bg-bg flex flex-col" x-transition>
        <div class="h-14 px-4 flex items-center justify-between border-b border-gray-800 bg-surface"><button @click="gameModalOpen = false" class="text-gray-400"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button><span class="font-bold">å“ˆå¸ŒçŒœå•åŒ</span><div class="w-8"></div></div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <div class="flex bg-gray-900 p-1 rounded-lg mb-4"><button @click="playMode='web3'" :class="playMode==='web3'?'bg-gray-700 text-white':'text-gray-500'" class="flex-1 py-2 text-xs font-bold rounded">ä¸€é”®ä¸‹æ³¨ (Web3)</button><button @click="playMode='qr'" :class="playMode==='qr'?'bg-gray-700 text-white':'text-gray-500'" class="flex-1 py-2 text-xs font-bold rounded">æ‰«ç è½¬è´¦</button></div>
            <div x-show="playMode==='web3'" class="space-y-6 text-center"><input type="number" x-model="betAmount" class="bg-black/30 border border-gray-700 rounded-xl px-4 py-4 text-2xl text-center text-white w-full font-bold focus:border-primary outline-none"><div class="grid grid-cols-2 gap-4"><button @click="doBet(1)" class="h-24 rounded-xl bg-purple-600 flex flex-col items-center justify-center shadow-lg"><span class="text-2xl font-bold text-white">å•</span></button><button @click="doBet(0)" class="h-24 rounded-xl bg-blue-500 flex flex-col items-center justify-center shadow-lg"><span class="text-2xl font-bold text-white">åŒ</span></button></div></div>
            <div x-show="playMode==='qr'" class="text-center"><div class="bg-white p-2 rounded-xl w-40 h-40 mx-auto mb-4" id="qrcode-container"></div><div class="bg-gray-800 p-3 rounded mb-4 text-xs font-mono text-gray-300 break-all" x-text="config.receiveAddr"></div><button @click="copyAddr()" class="bg-primary text-white px-6 py-2 rounded-full text-sm font-bold">å¤åˆ¶åœ°å€</button></div>
        </div>
    </div>

    <div x-show="walletSelectModalOpen" @click.away="walletSelectModalOpen = false" x-transition.opacity class="fixed inset-0 z-[70] flex items-center justify-center modal-bg">
        <div @click.stop class="bg-surface rounded-xl p-6 w-11/12 max-w-sm border border-gray-700 shadow-2xl space-y-4">
            <h3 class="text-lg font-bold text-white border-b border-gray-700 pb-3">é€‰æ‹©é’±åŒ…è¿›è¡Œè¿æ¥</h3>
            
            <button @click="connectTronLink()" class="w-full flex items-center justify-between bg-black/30 hover:bg-black/50 p-3 rounded-lg border border-gray-700 transition">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full bg-primary/20 text-primary flex items-center justify-center"><i class="fa-solid fa-plug text-sm"></i></div>
                    <span class="font-semibold text-sm">TronLink (æ¨è)</span>
                </div>
                <i class="fa-solid fa-check-circle text-primary"></i>
            </button>
            
            <button @click="alert('å½“å‰ DApp è¿è¡Œäºæ³¢åœºï¼ˆTronï¼‰ç½‘ç»œï¼Œè¯·åœ¨æ‚¨çš„é’±åŒ…ä¸­åˆ‡æ¢åˆ°æ³¢åœºç½‘ç»œåå†å°è¯•è¿æ¥ã€‚')" class="w-full flex items-center justify-between bg-black/30 hover:bg-black/50 p-3 rounded-lg border border-gray-700 transition opacity-80">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full bg-yellow-600/20 text-yellow-500 flex items-center justify-center"><i class="fa-solid fa-briefcase text-sm"></i></div>
                    <span class="font-semibold text-sm">OKX Wallet (æ¬§æ˜“é’±åŒ…)</span>
                </div>
                <i class="fa-solid fa-arrow-right text-gray-500"></i>
            </button>

            <button @click="alert('å½“å‰ DApp è¿è¡Œäºæ³¢åœºï¼ˆTronï¼‰ç½‘ç»œï¼Œè¯·åœ¨æ‚¨çš„é’±åŒ…ä¸­åˆ‡æ¢åˆ°æ³¢åœºç½‘ç»œåå†å°è¯•è¿æ¥ã€‚')" class="w-full flex items-center justify-between bg-black/30 hover:bg-black/50 p-3 rounded-lg border border-gray-700 transition opacity-80">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-key text-sm"></i></div>
                    <span class="font-semibold text-sm">TokenPocket</span>
                </div>
                <i class="fa-solid fa-arrow-right text-gray-500"></i>
            </button>

            <button @click="connectWC()" class="w-full flex items-center justify-between bg-black/30 hover:bg-black/50 p-3 rounded-lg border border-gray-700 transition opacity-70">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full bg-gray-500/20 text-gray-400 flex items-center justify-center"><i class="fa-solid fa-qrcode text-sm"></i></div>
                    <span class="font-semibold text-sm">WalletConnect (ç§»åŠ¨ç«¯)</span>
                </div>
                <i class="fa-solid fa-arrow-right text-gray-500"></i>
            </button>

            <button @click="alert('å½“å‰ DApp è¿è¡Œäºæ³¢åœºï¼ˆTronï¼‰ç½‘ç»œï¼ŒMetaMask é»˜è®¤ä¸æ”¯æŒæ³¢åœºäº¤æ˜“ã€‚è¯·ç¡®ä¿æ‚¨å·²åœ¨é’±åŒ…ä¸­æ·»åŠ æ³¢åœºç½‘ç»œå¹¶åˆ‡æ¢ï¼Œæˆ–ä½¿ç”¨ TronLink é’±åŒ…ã€‚')" class="w-full flex items-center justify-between bg-black/30 hover:bg-black/50 p-3 rounded-lg border border-gray-700 transition opacity-70">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full bg-orange-600/20 text-orange-400 flex items-center justify-center"><i class="fa-solid fa-mask text-sm"></i></div>
                    <span class="font-semibold text-sm">MetaMask / EVM é’±åŒ…</span>
                </div>
                <i class="fa-solid fa-xmark-circle text-red-500"></i>
            </button>

            <button @click="walletSelectModalOpen = false" class="w-full text-xs text-gray-400 hover:text-white pt-2">å–æ¶ˆ</button>
        </div>
    </div>

    <div x-show="wcModalOpen" @click.away="wcModalOpen = false" x-transition.opacity class="fixed inset-0 z-[80] flex items-center justify-center modal-bg">
        <div @click.stop class="bg-surface rounded-xl p-6 w-11/12 max-w-sm border border-gray-700 shadow-2xl space-y-4 text-center">
            <h3 class="text-xl font-bold text-white mb-4">é€šè¿‡ WalletConnect è¿æ¥</h3>
            
            <div id="wc-qrcode-container" class="bg-white p-2 rounded-xl mx-auto w-44 h-44 flex items-center justify-center">
                <i x-show="!wcUri" class="fa-solid fa-spinner fa-spin text-4xl text-gray-500"></i>
                </div>
            
            <p class="text-sm text-gray-300 mt-4">
                è¯·ä½¿ç”¨æ‚¨çš„ç§»åŠ¨é’±åŒ…æ‰«æä¸Šæ–¹äºŒç»´ç è¿›è¡Œæˆæƒã€‚
            </p>
            <p class="text-xs text-red-400 mt-2 px-2">
                âš ï¸ **é‡è¦è­¦å‘Šï¼š**
                WalletConnect è¿æ¥æˆåŠŸåï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åœ°å€ï¼Œä½†**å½“å‰ DApp çš„äº¤æ˜“ï¼ˆä¸‹æ³¨ã€ä¼—ç­¹ï¼‰åŠŸèƒ½ä»ä¾èµ– TronLink**ã€‚å¦‚éœ€äº¤æ˜“ï¼Œè¯·ä½¿ç”¨ TronLinkã€‚
            </p>

            <button @click="wcModalOpen = false; disconnectWC()" class="w-full bg-primary text-white py-2 rounded-lg font-bold mt-4">å…³é—­/å–æ¶ˆè¿æ¥</button>
        </div>
    </div>


    <script>
        const CONFIG = {
            receiveAddr: "THPWTQ8rYTAMb4UqCmksdswTXWkxLdA8Lm",
            contractAddr: "THPWTQ8rYTAMb4UqCmksdswTXWksssss"
        };

        function app() {
            return {
                activeTab: 'home',
                investType: 'equity',
                gameModalOpen: false,
                walletSelectModalOpen: false, 
                wcModalOpen: false, 
                playMode: 'web3',
                wallet: '',
                balance: '0.00',
                betAmount: 10,
                investAmount: '',
                btnText: 'è¿æ¥é’±åŒ…',
                config: CONFIG,
                
                pollingId: null, 
                // ğŸŒŸ WalletConnect çŠ¶æ€
                wcClient: null,
                wcUri: '',

                // åˆå§‹åŒ–
                init() {
                    console.log("Starting Engine in Passive Mode...");
                    
                    if (window.tronWeb) {
                        window.addEventListener('message', e => {
                            if (e.data.message && (e.data.message.action === 'setAccount' || e.data.message.action === 'setNode')) {
                                console.log('Wallet state changed via event. Checking connection...');
                                if(this.pollingId) {
                                    this.forceCheckWallet(); 
                                }
                            }
                        });
                    }
                    
                    // WalletConnect ç›‘å¬å™¨
                    this.$watch('wcModalOpen', (open) => {
                        if(open && !this.wcClient) {
                            // ç¡®ä¿æ¯æ¬¡æ‰“å¼€å¼¹çª—æ—¶éƒ½å°è¯•åˆå§‹åŒ–è¿æ¥
                            this.initializeWC();
                        }
                    });
                },

                // ğŸŒŸ WalletConnect åˆå§‹åŒ–åŠäº‹ä»¶ç›‘å¬
                async initializeWC() {
                    if (typeof WalletConnect === 'undefined') {
                        alert("WalletConnect åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ CDN é“¾æ¥ã€‚");
                        this.wcModalOpen = false;
                        return;
                    }

                    try {
                        // 1. å®ä¾‹åŒ– WalletConnect å®¢æˆ·ç«¯
                        this.wcClient = new WalletConnect.default({
                            bridge: "https://bridge.walletconnect.org", // é»˜è®¤æ¡¥æ¥æœåŠ¡å™¨
                            qrcodeModal: false, // ä¸ä½¿ç”¨å†…ç½®çš„æ¨¡æ€æ¡†
                        });

                        // 2. ç›‘å¬è¿æ¥äº‹ä»¶
                        this.wcClient.on("session_request", (error, payload) => {
                            if (error) { throw error; }
                            // åœ¨è¿™é‡Œå¯ä»¥å¤„ç†ä¸€äº›ç‰¹å®šäºæ³¢åœºçš„è¿æ¥è¯·æ±‚ï¼Œä½†é€šå¸¸æˆ‘ä»¬ä¾èµ– WalletConnect é€‚é…å™¨ã€‚
                            // ç”±äºæ˜¯æ¼”ç¤ºï¼Œæˆ‘ä»¬ç›´æ¥ç›‘å¬ session_update
                        });

                        this.wcClient.on("session_update", (error, payload) => {
                            if (error) { throw error; }
                            this.handleWCSession(payload);
                        });

                        this.wcClient.on("connect", (error, payload) => {
                            if (error) { throw error; }
                            this.handleWCSession(payload);
                        });

                        this.wcClient.on("disconnect", (error, payload) => {
                            if (error) { throw error; }
                            this.disconnectWC();
                        });

                        // 3. æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰ä¼šè¯
                        if (this.wcClient.connected) {
                            this.handleWCSession({ params: [this.wcClient.session] });
                            this.wcModalOpen = false; // å¦‚æœå·²è¿æ¥ï¼Œå…³é—­å¼¹çª—
                        } else {
                            // 4. åˆ›å»ºæ–°ä¼šè¯å¹¶æ˜¾ç¤º QR ç  URI
                            await this.wcClient.createSession({ chainId: 195 }); // 195æ˜¯æ³¢åœºçš„æµ‹è¯•é“¾IDï¼Œæ­£å¼ç¯å¢ƒåº”è¯¥ä½¿ç”¨ä¸€ä¸ªé€šç”¨æˆ–é€‚é…çš„ID
                            this.wcUri = this.wcClient.uri;
                            this.renderWCQRCode(this.wcUri);
                        }

                    } catch (e) {
                        console.error("WalletConnect Error:", e);
                        alert("WalletConnect å¯åŠ¨å¤±è´¥ã€‚è¯·åˆ·æ–°é‡è¯•ã€‚");
                        this.wcModalOpen = false;
                    }
                },

                // ğŸŒŸ å¤„ç† WalletConnect ä¼šè¯æ›´æ–°
                handleWCSession(payload) {
                    const session = payload.params[0];
                    if (session.accounts && session.accounts.length > 0) {
                        // WalletConnect è¿”å›çš„æ˜¯ TRON åœ°å€ (Tå­—æ¯å¼€å¤´)
                        this.wallet = session.accounts[0]; 
                        this.wcModalOpen = false;
                        this.btnText = "å·²è¿æ¥ (WC)";
                        alert(`WalletConnect è¿æ¥æˆåŠŸï¼åœ°å€: ${this.shortAddr(this.wallet)}\n\nâš ï¸ è­¦å‘Š: äº¤æ˜“åŠŸèƒ½ä»ä¾èµ– TronLinkï¼Œæ­¤è¿æ¥ä»…ç”¨äºåœ°å€æ˜¾ç¤ºã€‚`);
                        this.stopPolling(); // åœæ­¢ TronLink è½®è¯¢
                    }
                },

                // ğŸŒŸ æ¸²æŸ“ WalletConnect QR ç 
                renderWCQRCode(uri) {
                    const box = document.getElementById("wc-qrcode-container");
                    if(box) { 
                        box.innerHTML = ""; // æ¸…ç©ºåŠ è½½åŠ¨ç”»
                        new QRCode(box, { 
                            text: uri, 
                            width: 160, 
                            height: 160,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        }); 
                    }
                },

                // ğŸŒŸ æ–­å¼€ WalletConnect è¿æ¥
                async disconnectWC() {
                    if (this.wcClient && this.wcClient.connected) {
                        await this.wcClient.killSession();
                    }
                    this.wcClient = null;
                    this.wcUri = '';
                    this.disconnect(); // è°ƒç”¨åŸºç¡€æ–­å¼€å‡½æ•°
                },


                // --- è½®è¯¢å¼€å…³ --- (ä»…ç”¨äº TronLink)
                startPolling() {
                    if (this.pollingId) return; 
                    this.pollingId = setInterval(() => {
                        this.forceCheckWallet();
                    }, 1000);
                    console.log("TronLink Polling started.");
                },
                stopPolling() {
                    if (this.pollingId) {
                        clearInterval(this.pollingId);
                        this.pollingId = null; 
                        console.log("TronLink Polling stopped.");
                    }
                },


                // --- å¼ºåˆ¶æ£€æŸ¥å‡½æ•° (ä»…æ£€æŸ¥ TronLink æ³¨å…¥) ---
                async forceCheckWallet() {
                    if (window.tronWeb && window.tronWeb.ready) {
                        if (this.wallet !== window.tronWeb.defaultAddress.base58) {
                            this.wallet = window.tronWeb.defaultAddress.base58;
                            this.btnText = "å·²è¿æ¥";
                            try {
                                const bal = await window.tronWeb.trx.getBalance(this.wallet);
                                this.balance = (bal / 1e6).toFixed(2);
                            } catch(e) {}
                        }
                    } else {
                        // å¦‚æœ TronLink æ‰çº¿ï¼Œä¸”å½“å‰ä¸æ˜¯ WalletConnect è¿æ¥çŠ¶æ€
                        if (this.wcClient === null || !this.wcClient.connected) {
                            this.wallet = '';
                            this.balance = '0.00';
                            this.btnText = "è¿æ¥é’±åŒ…";
                            this.stopPolling();
                        }
                    }
                },

                // --- TronLink è¿æ¥é€»è¾‘ ---
                async connectTronLink() {
                    this.walletSelectModalOpen = false;
                    this.btnText = "è¿æ¥ä¸­...";
                    
                    if (!window.tronWeb) {
                        alert("æœªæ£€æµ‹åˆ° TronLink é’±åŒ…æ’ä»¶ï¼Œè¯·å®‰è£…ï¼");
                        this.btnText = "è¿æ¥é’±åŒ…";
                        return;
                    }

                    try {
                        await window.tronWeb.request({ method: 'tron_requestAccounts' });
                        this.btnText = "ç­‰å¾…æˆæƒ/è§£é”..."; 
                        this.startPolling(); 

                    } catch(e) {
                        console.error("è¿æ¥è¯·æ±‚å¤±è´¥:", e.message);
                        this.btnText = "è¿æ¥é’±åŒ…";
                        alert("è¿æ¥è¯·æ±‚å¤±è´¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„ TronLink æ’ä»¶æ˜¯å¦å·²è§£é”æˆ–æ˜¯å¦æ‹’ç»äº†æˆæƒã€‚");
                    }
                },

                // ğŸŒŸ WalletConnect è¿æ¥å…¥å£ (å¯åŠ¨ QR ç å¼¹çª—)
                async connectWC() {
                    this.walletSelectModalOpen = false;
                    this.wcModalOpen = true; 
                    this.btnText = "è¿æ¥ä¸­..."; 

                    // å¯åŠ¨ WalletConnect æµç¨‹ (åœ¨ $watch('wcModalOpen') ä¸­è°ƒç”¨ initializeWC)
                },

                // --- æ–­å¼€é’±åŒ… (é€šç”¨) ---
                disconnect() {
                    this.stopPolling();
                    this.wallet = '';
                    this.balance = '0.00';
                    this.btnText = "è¿æ¥é’±åŒ…";
                    if (this.wcClient) {
                         this.disconnectWC(); // å¦‚æœæ˜¯ WC è¿æ¥ï¼Œæ–­å¼€ WC
                    }
                },
                
                // --- å…¶ä»– DApp é€»è¾‘ (ä¿æŒä¸å˜) ---
                openGame(type) {
                    this.gameModalOpen = true;
                    setTimeout(() => {
                        const box = document.getElementById("qrcode-container");
                        if(box) { box.innerHTML = ""; new QRCode(box, { text: CONFIG.receiveAddr, width: 140, height: 140 }); }
                    }, 100);
                },
                shortAddr(addr) { return addr ? addr.slice(0,4) + '...' + addr.slice(-4) : ''; },
                copyAddr() { navigator.clipboard.writeText(CONFIG.receiveAddr); alert("åœ°å€å·²å¤åˆ¶"); },
                async doBet(guess) {
                    if(!this.wallet) return alert("è¯·å…ˆè¿æ¥é’±åŒ…ï¼ï¼ï¼ï¼");
                    // âš ï¸ æ³¨æ„ï¼šWalletConnect è¿æ¥çŠ¶æ€ä¸‹ï¼Œwindow.tronWeb ä¸å­˜åœ¨ï¼Œäº¤æ˜“ä¼šå¤±è´¥ï¼
                    if (!window.tronWeb) return alert("äº¤æ˜“å¤±è´¥ï¼šå½“å‰è¿æ¥çš„é’±åŒ…ï¼ˆå¦‚ WalletConnectï¼‰ä¸æ”¯æŒç›´æ¥è°ƒç”¨ TronLink çš„äº¤æ˜“å‡½æ•°ã€‚è¯·ä½¿ç”¨ TronLink é’±åŒ…ã€‚");
                    
                    let amountSun = window.tronWeb.toSun(this.betAmount);
                    let finalAmount = parseInt(amountSun) + (guess === 1 ? 1 : 2);
                    try {
                        const res = await window.tronWeb.trx.sendTransaction(CONFIG.receiveAddr, finalAmount);
                        alert("âœ… ä¸‹æ³¨æˆåŠŸï¼ï¼ï¼ï¼");
                    } catch(e) { alert("äº¤æ˜“å–æ¶ˆ"); }
                },
                async doInvest() {
                    if(!this.wallet) return alert("è¯·å…ˆè¿æ¥é’±åŒ…");
                    // âš ï¸ æ³¨æ„ï¼šWalletConnect è¿æ¥çŠ¶æ€ä¸‹ï¼Œwindow.tronWeb ä¸å­˜åœ¨ï¼Œäº¤æ˜“ä¼šå¤±è´¥ï¼
                    if (!window.tronWeb) return alert("äº¤æ˜“å¤±è´¥ï¼šå½“å‰è¿æ¥çš„é’±åŒ…ï¼ˆå¦‚ WalletConnectï¼‰ä¸æ”¯æŒç›´æ¥è°ƒç”¨ TronLink çš„äº¤æ˜“å‡½æ•°ã€‚è¯·ä½¿ç”¨ TronLink é’±åŒ…ã€‚");

                    if(!this.investAmount) return alert("è¯·è¾“å…¥é‡‘é¢");
                    try {
                        let contract = await window.tronWeb.contract().at(CONFIG.contractAddr);
                        await contract.invest().send({ callValue: window.tronWeb.toSun(this.investAmount) });
                        alert("ğŸ‰ ä¼—ç­¹æˆåŠŸï¼");
                    } catch(e) { alert("äº¤æ˜“å¤±è´¥: " + e.message); }
                }
            }
        }
    </script>
</body>
</html>
